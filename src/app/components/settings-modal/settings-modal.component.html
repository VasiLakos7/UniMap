<ion-header>
  <ion-toolbar class="settings-topbar">
    <ion-title>{{ 'SETTINGS.TITLE' | translate }}</ion-title>

    <ion-buttons slot="end">
      <ion-button fill="clear" (click)="close()" [attr.aria-label]="'COMMON.CLOSE' | translate">
        <ion-icon name="close-outline" slot="icon-only"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>

  <ion-toolbar class="settings-tabs">
    <ion-segment [(ngModel)]="activeTab">
      <ion-segment-button value="general" layout="icon-top">
        <ion-icon name="options-outline"></ion-icon>
        <ion-label>{{ 'SETTINGS.TABS.GENERAL' | translate }}</ion-label>
      </ion-segment-button>

      <ion-segment-button value="map" layout="icon-top">
        <ion-icon name="map-outline"></ion-icon>
        <ion-label>{{ 'SETTINGS.TABS.MAP' | translate }}</ion-label>
      </ion-segment-button>

      <ion-segment-button value="support" layout="icon-top">
        <ion-icon name="help-circle-outline"></ion-icon>
        <ion-label>{{ 'SETTINGS.TABS.SUPPORT' | translate }}</ion-label>
      </ion-segment-button>
    </ion-segment>
  </ion-toolbar>
</ion-header>

<ion-content class="settings-content ion-padding">
  <!-- GENERAL -->
  <ng-container *ngIf="activeTab === 'general'">
    <div class="section-card">
      <div class="section-title">
        <ion-icon name="options-outline"></ion-icon>
        <span>{{ 'SETTINGS.SECTIONS.GENERAL' | translate }}</span>
      </div>

      <ion-item lines="full">
        <ion-label>
          <h2>{{ 'SETTINGS.LANGUAGE.TITLE' | translate }}</h2>
        </ion-label>

        <div slot="end" class="end-control end-control--select">
          <ion-select
            class="end-select"
            [(ngModel)]="draft.language"
            interface="popover"
            (ionChange)="markDirty()"
          >
            <ion-select-option value="el">{{ 'LANG.EL' | translate }}</ion-select-option>
            <ion-select-option value="en">{{ 'LANG.EN' | translate }}</ion-select-option>
          </ion-select>
        </div>
      </ion-item>

      <!-- Units row -->
      <div class="units-row">
        <div class="units-text">
          <div class="units-title">{{ 'SETTINGS.UNITS.TITLE' | translate }}</div>
          <div class="units-sub">{{ 'SETTINGS.UNITS.SUB' | translate }}</div>
        </div>

        <div class="units-toggle" role="group" [attr.aria-label]="'SETTINGS.UNITS.ARIA' | translate">
          <button
            type="button"
            class="unit-btn"
            [class.active]="draft.units === 'm'"
            (click)="draft.units='m'; markDirty()"
          >
            {{ 'SETTINGS.UNITS.M' | translate }}
          </button>

          <button
            type="button"
            class="unit-btn"
            [class.active]="draft.units === 'km'"
            (click)="draft.units='km'; markDirty()"
          >
            {{ 'SETTINGS.UNITS.KM' | translate }}
          </button>
        </div>
      </div>
    </div>

    <div class="section-card">
      <div class="section-title">
        <ion-icon name="flash-outline"></ion-icon>
        <span>{{ 'SETTINGS.SECTIONS.ACTIONS' | translate }}</span>
      </div>

      <ion-item button detail="false" (click)="requestRefreshMap()">
        <ion-icon name="refresh-outline" slot="start"></ion-icon>
        <ion-label>{{ 'SETTINGS.ACTIONS.REFRESH_MAP' | translate }}</ion-label>
      </ion-item>

      <div class="progress-wrap" *ngIf="refreshing">
        <div class="progress-label">
          {{ 'SETTINGS.ACTIONS.REFRESHING' | translate }}â€¦ {{ refreshPct }}%
        </div>
        <ion-progress-bar [value]="refreshPct/100"></ion-progress-bar>
      </div>
    </div>
  </ng-container>

  <!-- MAP -->
  <ng-container *ngIf="activeTab === 'map'">
    <div class="section-card">
      <div class="section-title">
        <ion-icon name="map-outline"></ion-icon>
        <span>{{ 'SETTINGS.SECTIONS.MAP_VIEW' | translate }}</span>
      </div>

      <ion-item class="north-lock-item" lines="full">
        <ion-label>
          <h2>{{ 'SETTINGS.MAP.NORTH_LOCK' | translate }}</h2>
          <p>{{ 'SETTINGS.MAP.NORTH_LOCK_SUB' | translate }}</p>
        </ion-label>

        <div slot="end" class="end-control end-control--toggle">
          <ion-toggle [(ngModel)]="draft.northLock" (ionChange)="markDirty()"></ion-toggle>
        </div>
      </ion-item>

      <ion-item>
        <ion-label>
          <h2>{{ 'SETTINGS.MAP.MAP_TYPE' | translate }}</h2>
          <p>{{ 'SETTINGS.MAP.MAP_TYPE_SUB' | translate }}</p>
        </ion-label>

        <div slot="end" class="end-control end-control--select">
          <ion-select
            class="end-select"
            [(ngModel)]="draft.baseLayer"
            interface="popover"
            (ionChange)="markDirty()"
          >
            <ion-select-option value="osm">
              {{ 'SETTINGS.MAP.OSM' | translate }}
            </ion-select-option>

            <ion-select-option value="maptiler">
              {{ 'SETTINGS.MAP.MAPTILER' | translate }}
            </ion-select-option>
          </ion-select>
        </div>
      </ion-item>
    </div>

    <div class="section-card danger">
      <div class="section-title">
        <ion-icon name="refresh-circle-outline"></ion-icon>
        <span>{{ 'SETTINGS.RESET.TITLE' | translate }}</span>
      </div>

      <ion-item button detail="false" (click)="reset()">
        <ion-icon name="trash-outline" slot="start"></ion-icon>
        <ion-label>{{ 'SETTINGS.RESET.BUTTON' | translate }}</ion-label>
      </ion-item>
    </div>
  </ng-container>

  <!-- SUPPORT -->
  <ng-container *ngIf="activeTab === 'support'">
    <div class="section-card">
      <div class="section-title">
        <ion-icon name="mail-outline"></ion-icon>
        <span>{{ 'SETTINGS.SECTIONS.CONTACT' | translate }}</span>
      </div>

      <ion-item button detail="true" (click)="sendFeedback()">
        <ion-icon name="chatbubbles-outline" slot="start"></ion-icon>
        <ion-label>
          <h2>{{ 'SETTINGS.SUPPORT.FEEDBACK_TITLE' | translate }}</h2>
          <p>{{ 'SETTINGS.SUPPORT.FEEDBACK_SUB' | translate }}</p>
        </ion-label>
      </ion-item>
    </div>

    <div class="section-card">
      <div class="section-title">
        <ion-icon name="information-circle-outline"></ion-icon>
        <span>{{ 'SETTINGS.SECTIONS.ABOUT' | translate }}</span>
      </div>

      <ion-item lines="full">
        <ion-icon name="apps-outline" slot="start"></ion-icon>
        <ion-label>
          <h2>{{ 'SETTINGS.ABOUT.VERSION' | translate }}</h2>
          <p>{{ appVersion }}</p>
        </ion-label>
      </ion-item>

      <ion-item button detail="true" (click)="openPrivacy()">
        <ion-icon name="shield-checkmark-outline" slot="start"></ion-icon>
        <ion-label>
          <h2>{{ 'SETTINGS.ABOUT.PRIVACY_TITLE' | translate }}</h2>
          <p>{{ 'SETTINGS.ABOUT.PRIVACY_SUB' | translate }}</p>
        </ion-label>
      </ion-item>
    </div>
  </ng-container>

  <div class="actions" *ngIf="activeTab !== 'support'">
    <ion-button expand="block" (click)="save()" [disabled]="!dirty">
      {{ 'COMMON.SAVE' | translate }}
    </ion-button>
  </div>
</ion-content>
